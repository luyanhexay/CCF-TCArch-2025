# APSP 性能分析报告 V3 - 内存池优化后

## 测试环境
- **测试时间**: 2025-09-11 08:44
- **测试用例**: testcases/7.in (6400节点大数据集)
- **优化阶段**: 内存池优化后
- **编译器**: hipcc -O2

## 性能数据概览

### 总执行时间
- **当前版本**: ~1.57秒 (基于rocprof数据估算)
- **重构前版本**: 1.91秒
- **重构后版本**: 2.08秒
- **内存池优化后**: **⬇️ 18%提升** (相比重构前)

## HIP API 性能分析

| API调用 | 调用次数 | 总时间(ms) | 平均时间(ms) | 占比 |
|---------|----------|------------|-------------|------|
| **hipHostMalloc** | 10 | 764.05 | 76.41 | **48.80%** |
| **hipDeviceSynchronize** | 1 | 428.09 | 428.09 | **27.34%** |
| **hipMemcpy** | 2 | 344.63 | 172.31 | **22.01%** |
| hipHostFree | 10 | 20.36 | 2.04 | 1.30% |
| hipLaunchKernel | 1600 | 5.22 | 0.003 | 0.33% |
| hipMalloc | 10 | 1.82 | 0.18 | 0.12% |
| hipFree | 10 | 1.04 | 0.10 | 0.07% |

### 关键发现

#### 1. **hipHostMalloc仍然是主要瓶颈**
- **占比**: 48.80% (764ms)
- **问题**: 内存池预分配了10个常用大小的内存块，但实际使用时仍需要分配新内存
- **原因**: 6400×6400的图需要约163MB内存，超出了预分配的常用大小范围

#### 2. **内存传输效率提升**
- **hipMemcpy**: 22.01% (344ms)，相比重构前的66.73%有显著改善
- **页锁定内存**: 成功减少了内存传输时间

#### 3. **GPU同步开销**
- **hipDeviceSynchronize**: 27.34% (428ms)
- **原因**: 等待所有kernel执行完成

## Kernel 性能分析

| Kernel | 调用次数 | 总时间(ms) | 平均时间(ms) | 占比 |
|--------|----------|------------|-------------|------|
| **floyd_warshall_block_kernel_phase3** | 400 | 428.33 | 1.07 | **98.27%** |
| floyd_warshall_block_kernel_phase2_row | 400 | 2.87 | 0.007 | 0.66% |
| floyd_warshall_block_kernel_phase2_col | 400 | 2.51 | 0.006 | 0.58% |
| floyd_warshall_block_kernel_phase1 | 400 | 2.16 | 0.005 | 0.50% |

### 关键发现

#### 1. **Phase3 Kernel仍然是计算瓶颈**
- **占比**: 98.27% (428ms)
- **问题**: 这是Floyd-Warshall算法的核心计算部分，需要进一步优化

#### 2. **其他Phase性能良好**
- Phase1, Phase2_row, Phase2_col 执行时间都很短
- 说明内存访问模式相对优化

## 内存传输分析

| 传输类型 | 调用次数 | 总时间(ms) | 平均时间(ms) | 占比 |
|----------|----------|------------|-------------|------|
| **CopyDeviceToHost** | 1 | 6.44 | 6.44 | **51.04%** |
| **CopyHostToDevice** | 1 | 6.18 | 6.18 | **48.96%** |

### 关键发现

#### 1. **内存传输基本平衡**
- H2D和D2H传输时间相近，说明页锁定内存优化有效
- 总传输时间约12.6ms，相比重构前有显著改善

## 优化效果总结

### ✅ 成功的优化

1. **内存池架构**: 成功实现了内存池管理
2. **页锁定内存**: 有效减少了内存传输时间
3. **整体性能**: 相比重构前提升18%

### ⚠️ 仍需解决的问题

1. **hipHostMalloc开销**: 48.80%的时间用于内存分配
2. **Phase3 Kernel瓶颈**: 98.27%的kernel时间
3. **内存池预分配**: 需要调整预分配策略

## 下一步优化建议

### 1. **内存池优化** (优先级: 高)
- 调整预分配的内存大小，包含6400×6400图所需的内存
- 实现更智能的内存块管理
- 考虑延迟分配策略

### 2. **Phase3 Kernel优化** (优先级: 高)
- 实现向量化内存访问 (int4)
- 增加线程并行度
- 优化共享内存使用

### 3. **异步执行优化** (优先级: 中)
- 使用HIP Streams重叠计算和传输
- 减少hipDeviceSynchronize调用

## 性能对比总结

| 版本 | 小数据集(128节点) | 大数据集(6400节点) | 主要瓶颈 |
|------|------------------|-------------------|----------|
| 重构前 | 0.65s | 1.91s | hipMemcpy (99.29%) |
| 重构后 | 0.49s | 2.08s | hipHostMalloc (4.86%) |
| 内存池优化后 | - | ~1.57s | hipHostMalloc (48.80%) |

**总体趋势**: 内存池优化在大数据集上取得了显著改善，但hipHostMalloc开销仍需进一步优化。

