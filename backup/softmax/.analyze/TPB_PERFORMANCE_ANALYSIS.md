# TPB (Threads Per Block) 性能分析报告

## 测试概述
基于softmax.param.md的建议，对TPB参数进行了系统性测试，测试了5个不同的TPB值：64, 128, 256, 512, 1024。

## 测试结果汇总

| TPB值 | onlinePartialKernel (μs) | onlineFinalReduceKernel (μs) | softmaxWriteKernel (μs) | 总Kernel时间 (μs) | 性能排名 |
|-------|-------------------------|----------------------------|------------------------|------------------|----------|
| 64    | 49.12                   | 37.28                      | 12.80                  | 99.20            | 3        |
| 128   | 44.48                   | 33.60                      | 8.64                   | 86.72            | 2        |
| 256   | 42.72                   | 32.96                      | 7.68                   | 83.36            | 1        |
| 512   | 47.20                   | 32.80                      | 6.24                   | 86.24            | 4        |
| 1024  | 84.96                   | 25.76                      | 7.36                   | 118.08           | 5        |

## 关键发现

### 1. 最优TPB值
**TPB=256** 表现最佳，总kernel执行时间最短（83.36μs），相比默认的TPB=128提升了约3.9%。

### 2. 性能趋势分析
- **TPB=64到256**: 随着TPB增加，性能逐步提升
- **TPB=256**: 达到性能峰值
- **TPB=512**: 性能开始下降
- **TPB=1024**: 性能显著下降，onlinePartialKernel时间几乎翻倍

### 3. Kernel性能分析
- **onlinePartialKernel**: 在TPB=256时达到最佳性能（42.72μs）
- **onlineFinalReduceKernel**: 在TPB=512时达到最佳性能（32.80μs）
- **softmaxWriteKernel**: 在TPB=512时达到最佳性能（6.24μs）

### 4. 性能下降原因分析
- **TPB=1024**: 可能超出了GPU的warp大小限制，导致线程调度效率下降
- **TPB=512**: 虽然个别kernel性能最佳，但整体性能略有下降

## 建议

### 1. 推荐配置
**使用TPB=256作为最优配置**，理由：
- 总kernel执行时间最短
- 各kernel性能均衡
- 符合GPU架构特性

### 2. 进一步优化方向
- 可以测试TPB=192, 320等中间值
- 考虑不同数据集大小下的TPB优化
- 结合Grid Size Multiplier进行联合优化

## 测试环境
- GPU: MI100 (gfx908)
- 测试用例: testcases/10.in (最大数据集)
- 编译器: hipcc -O3
- 测试时间: 2025-09-11

## 下一步计划
1. 使用TPB=256进行Grid Size Multiplier测试
2. 测试页锁定内存阈值优化
3. 进行综合性能验证
